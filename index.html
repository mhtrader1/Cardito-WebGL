<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cardito Web</title>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        height: 100%;
      }

      #unity-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #unity-canvas {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(var(--scale, 1));
        transform-origin: center center;
        width: 1080px;
        height: 1920px;
        background: #000;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
        z-index: 1;
      }
    </style>

    <!-- ======================================================
         ğŸ”Œ Web3 prerequisites
         ====================================================== -->

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="ethers.js"></script>
    <script src="https://unpkg.com/@walletconnect/ethereum-provider/dist/index.umd.js"></script>

    <script>
      window.CARDITO_WC_PROJECT_ID = "7a03ac67d724cd7a88e72da1ec30c7f6";
    </script>

    <script src="SocketBridge.js"></script>

    <!-- ===== HTML Keyboard Overlay for mobile WebGL ===== -->
    <input id="cardito-html-input"
           type="text"
           style="
             position:fixed;
             left:50%;
             bottom:20px;
             transform:translateX(-50%);
             width:80%;
             max-width:400px;
             height:40px;
             padding:8px 10px;
             font-size:16px;
             border-radius:8px;
             border:1px solid #ccc;
             z-index:999999;
             display:none;
             background:#fff;
             color:#000;
           "
           autocomplete="off"
           autocorrect="off"
           autocapitalize="off"
           spellcheck="false" />

    <script>
      (function () {
        const el = document.getElementById("cardito-html-input");

        const overlay = {
          go: null,
          method: null,

          open(goName, methodName, placeholder, currentValue) {
            this.go = goName;
            this.method = methodName;
            el.placeholder = placeholder || "";
            el.value = currentValue || "";
            el.style.display = "block";

            // Ú©Ù…ÛŒ ØªØ£Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø·Ù…Ø¦Ù†Ø§Ù‹ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†Ø¯
            setTimeout(() => {
              el.focus();
              el.selectionStart = el.selectionEnd = el.value.length;
            }, 50);
          },

          close(sendBack) {
            el.style.display = "none";
            if (sendBack && this.go && this.method) {
              const val = el.value || "";
              try {
                if (typeof sendMessage === "function") {
                  sendMessage(this.go, this.method, val);
                } else if (typeof unityInstance !== "undefined" && unityInstance) {
                  unityInstance.SendMessage(this.go, this.method, val);
                } else if (typeof SendMessage === "function") {
                  SendMessage(this.go, this.method, val);
                }
              } catch (e) {
                console.error("[HTMLKeyboardOverlay] SendMessage error", e);
              }
            }
            this.go = null;
            this.method = null;
          }
        };

        el.addEventListener("blur", () => overlay.close(true));

        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            overlay.close(true);
          } else if (e.key === "Escape") {
            e.preventDefault();
            overlay.close(false);
          }
        });

        // Ø§ÛŒÙ† Ø¢Ø¨Ø¬Ú©Øª Ù‡Ù…Ø§Ù† Ú†ÛŒØ²ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø§Ø² C# Ø¨Ø§ Application.ExternalCall ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        window.HTMLKeyboardOverlay = overlay;
      })();
    </script>

<!-- ================================
     â­ Cardito Cinematic Loader (GSAP)
     ================================= -->
<style>
  #cardito-loader {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 999999;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    z-index: 999999;
  }

  .letter,
  #cardito-heart {
    position: absolute;
    bottom: calc(50% - 40px);           /* âœ… Ù‡Ù…Ù‡ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø±ÙˆÛŒ ÛŒÚ© Ø®Ø· Ù…Ø´ØªØ±Ú© Ù…ÛŒâ€ŒÙ†Ø´ÛŒÙ†Ù†Ø¯ */
    left: 50%;
    transform: translateX(-50%);  /* ÙÙ‚Ø· Ù…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ø§ÙÙ‚ÛŒØŒ Ø¨Ø¯ÙˆÙ† ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† Ø¹Ù…ÙˆØ¯ÛŒ */
    opacity: 0;
    width: auto;
    height: auto;
    
  }

  #cardito-heart {
    width: auto;
    pointer-events: none;
  }

  @media (max-width: 600px) {
    .letter {
      width: 16vw;
      max-width: 80px;
    }
    #cardito-heart {
      max-width: 30px;
    }
  }
</style>

<div id="cardito-loader">
  <img class="letter" id="L1" src="1.png">
  <img class="letter" id="L2" src="2.png">
  <img class="letter" id="L3" src="3.png">
  <img class="letter" id="L4" src="4.png">
  <img class="letter" id="L5" src="5.png"> <!-- Ø­Ø±Ù i Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø·Ù‡ -->
  <img class="letter" id="L6" src="6.png">
  <img class="letter" id="L7" src="7.png">
  <img id="cardito-heart" src="heart.png">
</div>

<!-- GSAP CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<script>
  // ÙÙ„Ú¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Unity
  window.CARDITO_ANIM_DONE = false;
  window.UNITY_READY = window.UNITY_READY || false;

  const CARDITO_LETTER_IDS = ["L1", "L2", "L3", "L4", "L5", "L6", "L7"];
  let HEART_BEATS = 0;

  // ØªØ§Ø¨Ø¹ Ú¯Ù„ÙˆØ¨Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ù„ÙˆØ¯Ø±ØŒ ØªØ§ Ø®Ø·Ø§ÛŒ undefined Ù†Ø¯Ù‡
  function tryStartUnityReveal() {
    const loader = document.getElementById("cardito-loader");
    if (!loader || !window.gsap) return;
    console.log("[tryStartUnityReveal] HEART_BEATS is =", HEART_BEATS);
    if (window.UNITY_READY && window.CARDITO_ANIM_DONE && HEART_BEATS >= 5) {
      gsap.to(loader, {
        opacity: 0,
        duration: 0.7,
        onComplete: () => {
          loader.style.display = "none";
        }
      });
    }
  }

  function initCarditoLoader() {
    const loader = document.getElementById("cardito-loader");
    if (!loader || !window.gsap) return;

    const letters = CARDITO_LETTER_IDS.map(id => document.getElementById(id));
    const heart = document.getElementById("cardito-heart");

    if (!letters.every(Boolean) || !heart) return;

    requestAnimationFrame(() => {
      // ÙÙ‚Ø· Ø¹Ø±Ø¶ ØªØµØ§ÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ
      const widths = letters.map(el => el.getBoundingClientRect().width || el.naturalWidth || 0);

      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø·ÙˆÙ„ Ú©Ù„
      let total = widths.reduce((a,b)=>a+b,0);
      const startX = -total / 2;
      const positions = {};
      let cursor = startX;

      for (let i = 0; i < widths.length; i++) {
        let  center = cursor + widths[i] / 2;
        if (CARDITO_LETTER_IDS[i] === "L4") { center -= 20; }
        positions[CARDITO_LETTER_IDS[i]] = center;
        cursor += widths[i] ;
      }

      // Ù„Ø§ÛŒÙ† Ø«Ø§Ø¨Øª Ù¾Ø§ÛŒÛŒÙ†: yEnd = 0 (Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø®Ø·)
      const dropYStart = -window.innerHeight * 0.25;
      const dropYEnd = 0;

      // ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ø­Ø±ÙˆÙ: Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ØŒ Ù†Ø§Ù…Ø±Ø¦ÛŒ
      letters.forEach((el, idx) => {
        const id = CARDITO_LETTER_IDS[idx];
        gsap.set(el, {
          x: positions[id],
          y: dropYStart,
          opacity: 0
        });
      });

      // Ù‚Ù„Ø¨ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù¾Ù†Ù‡Ø§Ù†
      gsap.set(heart, { opacity: 0, scale: 0.8 });

      // ØªØ§ÛŒÙ…â€ŒÙ„Ø§ÛŒÙ† Ø§ØµÙ„ÛŒ
      const tl = gsap.timeline({
        defaults: { duration: 1.4, ease: "power2.out" } // Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¬ / bounce
      });

      // Ø§ÙØªØ§Ø¯Ù† Ø­Ø±ÙˆÙ Ø±ÙˆÛŒ ÛŒÚ© Ø®Ø· Ø³ÙØªØŒ Ø¨Ø§ ÙØ§ØµÙ„Ù‡ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨ÛŒÙ† Ù‡Ø± Ø­Ø±Ù
      tl.to(letters, {
        y: dropYEnd,
        opacity: 1,
        stagger: 0.15   // ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨ÛŒÙ† Ø§ÙØªØ§Ø¯Ù† Ù‡Ø± Ø­Ø±Ù
      }, 0)

      // Ù…Ú©Ø« Û± Ø«Ø§Ù†ÛŒÙ‡ Ù‚Ø¨Ù„ Ø§Ø² Ù‚Ù„Ø¨
      .to({}, { duration: 1 });

      // Ø¬Ø§Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ù„Ø¨ Ø¨Ø§Ù„Ø§ÛŒ Ø­Ø±Ù i (L5)
      tl.add(() => {
        const iIndex = CARDITO_LETTER_IDS.indexOf("L5");
        const iEl = letters[iIndex];
        const iRect = iEl.getBoundingClientRect();
        const loaderRect = loader.getBoundingClientRect();

        const offsetX =
          (iRect.left + iRect.width / 2) -
          (loaderRect.left + loaderRect.width / 2);

        const offsetYTopOfI =
          iRect.top - (loaderRect.top + loaderRect.height / 2);

        // Ù‚Ù„Ø¨ Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ Ø­Ø±Ù i
        gsap.set(heart, {
          x: offsetX,
          y: offsetYTopOfI
        });
      });

      // Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ù‚Ù„Ø¨
      tl.to(heart, {
        opacity: 1,
        scale: 1,
        duration: 0.45,
        ease: "power2.out"
      });

      // Ù¾Ø§ÛŒØ§Ù† Ø³Ú©Ø§Ù†Ø³ Ø§ØµÙ„ÛŒ
      tl.call(() => {
        window.CARDITO_ANIM_DONE = true;
        
        gsap.to("#cardito-heart", {
          scale: 1.12,
          duration: 0.45,
          ease: "power1.inOut",
          yoyo: true,
          repeat: -1,
          onRepeat: () => {
            HEART_BEATS++;
            //console.log("â¤ï¸ BEAT #", HEART_BEATS);
            tryStartUnityReveal();
          }
        });
        
        
      });
    });
  }

  // Ù„ÙˆØ¯ ØªØµØ§ÙˆÛŒØ± + Ø´Ø±ÙˆØ¹ Ù„ÙˆØ¯Ø±
  window.addEventListener("load", () => {
    const imgs = CARDITO_LETTER_IDS.map(id => document.getElementById(id));
    const heart = document.getElementById("cardito-heart");
    const all = [...imgs, heart].filter(Boolean);

    let remaining = all.length;
    if (remaining === 0) {
      initCarditoLoader();
      return;
    }

    const done = () => {
      remaining--;
      if (remaining <= 0) initCarditoLoader();
    };

    all.forEach(img => {
      if (img.complete) {
        done();
      } else {
        img.addEventListener("load", done, { once: true });
        img.addEventListener("error", done, { once: true });
      }
    });
  });
</script>

    <!-- ================================
         â­ Original Unity Loader
         ================================= -->
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="1080" height="1920" tabindex="0"></canvas>

      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>

      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Cardito Web</div>
      </div>
    </div>

    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      canvas.tabIndex = 0;
      canvas.style.outline = "none";
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var warningBanner = document.querySelector("#unity-warning");

      window.UnitySelectedChain = 1; // default Ethereum
      window.SetUnitySelectedChain = function(cid){
        console.log("[HTML] Unity selected chain =", cid);
        window.UnitySelectedChain = parseInt(cid);
      };

      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? "block" : "none";
        }
        var div = document.createElement("div");
        div.innerHTML = msg;
        warningBanner.appendChild(div);

        if (type == "error") div.style = "background: red; padding: 10px;";
        else {
          if (type == "warning") div.style = "background: yellow; padding: 10px;";
          setTimeout(() => {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebGL.loader.js";

      var config = {
        dataUrl: buildUrl + "/WebGL.data",
        frameworkUrl: buildUrl + "/WebGL.framework.js",
        codeUrl: buildUrl + "/WebGL.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Cardito",
        productName: "Cardito Web",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement("meta");
        meta.name = "viewport";
        meta.content =
          "width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes";
        document.head.appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";
      } else {
        canvas.style.width = "1080px";
        canvas.style.height = "1920px";
      }

      loadingBar.style.display = "block";
      window.UNITY_READY = true;                       // âœ… Unity HTML logo / loading bar is now visible
      console.log("[HTML] UNITY_READY set â†’ Unity logo is visible");

      function waitForIntro() {
        return new Promise(resolve => {
          if (window.CARDITO_ANIM_DONE) return resolve();
          const interval = setInterval(() => {
            if (window.CARDITO_ANIM_DONE) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        });
      }

      var script = document.createElement("script");
      script.src = loaderUrl;

      script.onload = () => {
        
        waitForIntro().then(() => {
          createUnityInstance(canvas, config, (progress) => {
            progressBarFull.style.width = (progress * 100) + "%";
          }).then((unityInstance) => {

            window.sendMessage = function(obj, method, param) {
              try { unityInstance.SendMessage(obj, method, param); }
              catch (e) { console.error("[sendMessage ERROR]", e); }
            };

            loadingBar.style.display = "none";
            fullscreenButton.onclick = () => unityInstance.SetFullscreen(1);

            window.unityInstance = unityInstance;

          }).catch((msg) => console.error(msg));
        });
      };

      document.body.appendChild(script);
    </script>

    <!-- ======================
         Canvas Fitting Logic
         ====================== -->
    <script>
      function fitCanvas() {
        const canvas = document.getElementById("unity-canvas");
        const scaleX = window.innerWidth / 1080;
        const scaleY = window.innerHeight / 1920;
        const scale = Math.min(scaleX, scaleY);
        canvas.style.setProperty("--scale", scale);
      }

      window.addEventListener("resize", fitCanvas);
      fitCanvas();
    </script>

  </body>
</html>
